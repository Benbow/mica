<?php
/**
 * @file
 * Code for the Mica Community feature.
 */

include_once('mica_community.features.inc');


/**
 * Implements hook_create_default_content().
 */
function mica_community_create_default_content() {
  mica_core_create_menu(st('Community'), 'community', 'community', FALSE, TRUE, 45, NULL);
  mica_core_create_menu(st('News'), 'news', 'news', FALSE, FALSE, 1, 'community');
  $event_menu = mica_core_create_menu(st('Events'), 'events', 'events', FALSE, FALSE, 2, 'community');
  $forum_menu = mica_core_create_menu(st('Forums'), 'forum', 'forum', FALSE, FALSE, 3, 'community');
  $blog_menu = mica_core_create_menu(st('Blogs'), 'blog', 'blog', FALSE, FALSE, 4, 'community');

  $research_menu = mica_core_find_menu_for_alias('research');
  $publication_menu = mica_core_create_menu(st('Publications'), 'publications', 'publications', FALSE, FALSE, 10, $research_menu->link_path);
  
  mica_core_set_menu_option('event', $event_menu['mlid']);
  mica_core_set_menu_option('publication', $publication_menu['mlid']);
  mica_core_set_menu_option('forum', $forum_menu['mlid']);
  mica_core_set_menu_option('blog', $blog_menu['mlid']);
}

/**
 * Implements hook_menu_local_tasks_alter().
 */
function mica_community_menu_local_tasks_alter(&$data, $router_item, $root_path) {
  $links = array();

  if ($root_path === 'community') {
    if (node_access('create', 'contact')) {
      $links['add-contact'] = array(
        '#theme' => 'menu_local_action',
        '#link' => array(
          'title' => t('Add a Contact'),
          'href' => 'node/add/contact',
        ),
      );
    }
    if (node_access('create', 'institution')) {
      $links['add-institution'] = array(
        '#theme' => 'menu_local_action',
        '#link' => array(
          'title' => t('Add an Institution'),
          'href' => 'node/add/institution',
        ),
      );
    }
  }
  elseif ($root_path === 'events') {
    if (node_access('create', 'event')) {
      $links['add-event'] = array(
        '#theme' => 'menu_local_action',
        '#link' => array(
          'title' => t('Add an Event'),
          'href' => 'node/add/event',
        ),
      );
    }
  }
  elseif ($root_path === 'publications') {
    if (node_access('create', 'publication')) {
      $links['add-publication'] = array(
        '#theme' => 'menu_local_action',
        '#link' => array(
          'title' => t('Add a Publication'),
          'href' => 'node/add/publication',
        ),
      );
    }
  }

  $data['actions']['output'] = array_merge($data['actions']['output'], $links);
}

/**
 * Implements hook_node_insert()
 */
function mica_community_node_insert($node) {
  if ($node->type === 'publication' || $node->type === 'event') {
    mica_core_create_node_default_menu($node, TRUE);
  }
}
