<?php

/**
 * @file
 * Code for the Mica Community feature.
 */

include_once('mica_community.features.inc');

/**
 * Creates default content after Features successfully installed
 * Implements hook_post_features_rebuild().
 */
function mica_community_post_features_rebuild() {
  if (!variable_get('mica_community_features_rebuild_completed', FALSE)) {
    _mica_community_create_default_content();
    variable_set('mica_community_features_rebuild_completed', TRUE);
  }
}

function _mica_community_create_default_content() {
  $community_menu = mica_core_create_menu(st('Community'), 'community', 'community', FALSE, TRUE, 45, NULL);
  mica_core_create_menu(st('News'), 'news', 'news', FALSE, FALSE, 10, NULL, $community_menu['mlid']);
  $event_menu = mica_core_create_menu(st('Events'), 'events', 'events', FALSE, TRUE, 15, NULL, $community_menu['mlid']);
  mica_core_create_menu(st('Calendar'), 'calendar-field-event-date/year', 'calendar-field-event-date/year', FALSE, FALSE, 0, 'events');
  $forum_menu = mica_core_create_menu(st('Forums'), 'forum', 'forum', FALSE, FALSE, 20, NULL, $community_menu['mlid']);
  $blog_menu = mica_core_create_menu(st('Blogs'), 'blog', 'blog', FALSE, FALSE, 25, NULL, $community_menu['mlid']);

  $research_menu = mica_core_find_menu_for_alias('research');
  $publication_menu = mica_core_create_menu(st('Publications'), 'publications', 'publications', FALSE, FALSE, 10, NULL, $research_menu->mlid);

  mica_core_set_menu_option('event', $event_menu['mlid']);
  mica_core_set_menu_option('publication', $publication_menu['mlid']);
  mica_core_set_menu_option('forum', $forum_menu['mlid']);
  mica_core_set_menu_option('blog', $blog_menu['mlid']);
}

/**
 * Implements hook_menu_local_tasks_alter().
 */
function mica_community_menu_local_tasks_alter(&$data, $router_item, $root_path) {
  $links = array();

  if ($root_path === 'community') {
    if (node_access('create', 'contact')) {
      $links['add-contact'] = array(
        '#theme' => 'menu_local_action',
        '#link' => array(
          'title' => t('Add a Contact'),
          'href' => 'node/add/contact',
        ),
      );
    }
  }
  elseif ($root_path === 'events') {
    if (node_access('create', 'event')) {
      $links['add-event'] = array(
        '#theme' => 'menu_local_action',
        '#link' => array(
          'title' => t('Add an Event'),
          'href' => 'node/add/event',
        ),
      );
    }
  }
  elseif ($root_path === 'publications') {
    if (node_access('create', 'publication')) {
      $links['add-publication'] = array(
        '#theme' => 'menu_local_action',
        '#link' => array(
          'title' => t('Add a Publication'),
          'href' => 'node/add/publication',
        ),
      );
    }
  }

  $data['actions']['output'] = array_merge($data['actions']['output'], $links);
}

/**
 * Implements hook_node_insert().
 */
function mica_community_node_insert($node) {
  if ($node->type === 'publication' || $node->type === 'event') {
    mica_core_create_node_default_menu($node, TRUE);
  }
}
