<?php
/**
 * @file
 * Mica Datasets Crosstab module file
 */

function mica_query_menu() {

  $items['node/%node/variable-crosstab'] = array(
    'access callback' => 'node_access',
    'access arguments' => array('view', 1),
    'page callback' => 'drupal_get_form',
    'page arguments' => array('mica_query_run_page', 1, 3),
    'file' => 'mica_query.pages.crosstab.inc',
  );
  $items['variable-crosstab/%var1/%var2/xlsx'] = array(
    'access callback' => 'mica_core_nodes_access',
    'access arguments' => array('view', array(1, 2)),
    'page callback' => 'mica_query_run_xlsx',
    'page arguments' => array(1, 2),
    'file' => 'mica_query.pages.crosstab.inc',
  );
  return $items;
}

/**
 * Implements hook_menu_local_tasks_alter().
 */
function mica_query_menu_local_tasks_alter(&$data, $router_item, $root_path) {

  $links = array();
  switch ($root_path) {

    case 'node/%':
      $node = $router_item['page_arguments'][0];
      $wrapper = entity_metadata_wrapper('node', $node);
      // the variable must be a categorical variable
      if ($node != NULL && $node->type === 'variable' && count($wrapper->field_variable_categories->value()) > 1) {
        $links['view-variable-crosstab'] = array(
          '#theme' => 'menu_local_action',
          '#link' => array(
            'title' => t('Crosstab'),
            'href' => 'node/' . $wrapper->field_dataset->nid->value() . '/variable-crosstab/' . $node->nid,
            'localized_options' => array(
              'attributes' => array('class' => 'highlight'),
            )
          ),
        );
      }

      if ($node != NULL && $node->type === 'dataset' && node_access('view', 'dataset')) {
        $links['mica-query-crosstabulation'] = array(
          '#theme' => 'menu_local_action',
          '#link' => array(
            'title' => t('Crosstab'),
            'href' => 'node/' . $wrapper->nid->value() . '/variable-crosstab/',
            // Arguments could be taxonomies and dataset
            'localized_options' => array(
              'attributes' => array('class' => 'highlight'),
            )
          ),
        );
      }

      break;
  }

  $data['actions']['output'] = array_merge($data['actions']['output'], $links);

}

